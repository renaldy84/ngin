var net = require('net');

function Proxy (port, host, remotePort, remoteHost) {
    var self = this;
    self.buf_client = [];
    self.buf_stream = []
    self.stream = null;
    self.client = net.createConnection(remotePort, remoteHost);
    self.client.on("data", function (data) {
	if (self.stream && self.stream.writable) {
	    while (self.buf_stream.length) {
		self.stream.write(self.buf_stream.shift());
	    }
	    self.stream.write(data);
	} else {
	    self.buf_stream.push(data);
	}
    });
    self.client.on("connect", function () {
	self.buf_client.write("nc localhost 22\n");
	while (self.buf_client.length) {
	    self.client.write(self.buf_client.shift());
	}
    });
    self.server = net.createServer(function (stream) {
	if (self.stream) {
	    while (self.buf_stream.length) self.buf_stream.pop();
	    while (self.buf_client.length) self.buf_client.pop();
	    self.stream.destroy();
	}
	self.stream = stream;
	function buffer (data) {
	    this.buf_client.push(data);
	}
	stream.on("data", buffer);
	stream.on("connect", function () {
	    this.removeListener("data", buffer);
	    self.client.end();
	    self.client.connect(por,t 
	    while (self.buf_client.length) {
		self.client.write(self.buf_client.shift());
	    }
	    sys.pump(stream, self.client);
	});
	stream.on("end", function () {
	    for (var i = 0; i < self.connections.length; i++) {
		if (self.connections[i] == stream) {
		    self.connections.splice(i, 1);
		    break;
		}
	    }
	});
    });
}

var proxy = new Proxy (1080, "127.0.0.1", 22, "127.0.0.1");
