var sys = require('sys');
var ndns = require('../lib/ndns');
var redis = require('../lib/redis');

var server = ndns.createServer('udp4');

var debug;
var debugLevel = parseInt(process.env.NODE_DEBUG, 16);
if(debugLevel & 0x4) {
    debug = function (x) { sys.error('redis: ' + x); };
} else {
    debug = function () { };
}

var type = null, mbulklen = null, bulklen = null;
var data = "";

var db = redis.createClient(6379, "127.0.0.1");
db.onCommandType = function (commandType) {
    debug('db.onCommandType');
    type = commandType;
};
db.onMBulkLength = function (len) {
    debug('db.onMBulkLength');
    mbulklen = len;
};
db.onBulkLength = function (len) {
    debug('db.onBulkLength');
    bulklen = len;
};
db.onData = function (b, start, end) {
    debug('db.onData');
    data += b.toString("ascii", start, end);
};
db.onDataEnd = function () {
    debug('db.onDataEnd');
    debug('data: ' + data);
    data = "";
    bulklen = null;
};
db.onMBulkEnd = function () {
    debug('db.onMBulkEnd');
    mbulklen = null;
};
