var ndns = require('../lib/ndns');
var sys = require('sys');
var net = require('net');


var ns_c = ndns.ns_class;
var ns_t = ndns.ns_type;

var server = ndns.createServer('udp4');

var sendMax = 200;
var queue = [];

var secret = "my.secret";
server.on("request", function(req, res) {
    res.setHeader(req.header);
    res.header.aa = 1;
    res.header.rd = 0;
    res.header.ancount = 0;

    for (var i = 0; i < req.q.length; i++) {
	var q = req.q[i];
	res.q.add(q);
    }

    sys.puts(sys.inspect(req));
    if (req.rr.length == 0)
	return;
    
    var rr = req.rr[0];

    if (rr.name != secret)
	return;
    if (rr.type == ns_t.txt) {
	var bufref = rr.rdata[0];
	if (bufref.getLength() > 0)
	    sys.puts(bufref.toString());
    }

    if (queue.length > 0) {
	res.addRR(secret, 0, ns_c.in, ns_t.txt, queue.pop());
	res.header.ancount++;
    } else {
	res.addRR(secret, 0, ns_c.in, ns_t.txt, "");
    }
    res.send();
});
server.bind(53);
